---
title: "DataProcessing"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(forcats)
library(r2d3)
library(parcoords)
library(dplyr)
library(GGally)
```

## Data Import


```{r}
raw_data_path = "~/Dropbox/MealyzerData"
mealyser_data_overview = read_csv(file.path(raw_data_path, "mealyzer_data_overview.csv"), col_types = cols())
```


### Selecting users for the analysis

```{r}
users = mealyser_data_overview %>%
  filter(complete_meals > 14)
print(users[["user_id"]])
```

```{r}
read_mealyzer_files <- function(data_dir, user_ids, file_name, add_user_id, col_types) {
  result <- c()
  for (user_id in user_ids) {
    
    file_path = file.path(data_dir, as.character(user_id), file_name)
    df = read_csv(file_path, col_types = col_types)
    if (add_user_id) {
      df = cbind(user_id = user_id, df)
    }
    if (length(result) == 0) {
      result <- df
    } else {
      result <- rbind(result, df)
    }
  }
  return(result)
}

as.timestamp <- function(minutes_since, anchor_date = '2019-01-01 00:00:00 EST') {
  anchor_time = as.POSIXct(anchor_date)
  return(anchor_time + minutes_since * 60)
}

as.meals_kind <- function(values) {
  return(fct_relevel(values, c("breakfast", "morning_snack", "lunch", "afternoon_snack", "dinner", "after_dinner_snack")))
}

print_df <- function(df, ...) {
  print(df %>% select(...))
  return(df)
}

```

```{r}
bg_readings = read_mealyzer_files(raw_data_path, users[["user_id"]], "bg_labeled.csv", add_user_id = TRUE, col_types = cols(
  time = col_double(),
  bg = col_double(),
  meals_kind = col_character(),
  meal_id = col_double(),
  readings_kind = col_character()
)) %>%
  mutate(
    user_id = as.character(user_id),
    time = as.timestamp(time), 
    meals_kind = as.meals_kind(meals_kind),
    readings_kind = fct_relevel(readings_kind, c("premeal", "postmeal"))
  )
head(bg_readings)
```
```{r}
# No NA's in the bg_readings file
#extracat::visna(bg_readings)
```


```{r}
meals_data = read_mealyzer_files(raw_data_path, users[["user_id"]], "mealyzer_data.csv", add_user_id = FALSE, col_types = cols()) %>%
  mutate(
    user_id = as.character(user_id),
    eaten_at = as.timestamp(eaten_at),
    kind = as.meals_kind(kind),
    premeal_bg_time = as.timestamp(premeal_bg_time),
    postmeal_bg_time = as.timestamp(postmeal_bg_time),
    premeal_bg_delay_minutes = as.double(difftime(eaten_at, premeal_bg_time, units = "mins")),
    postmeal_bg_delay_minutes = as.double(difftime(postmeal_bg_time, eaten_at, units = "mins")),
    bg_impact = postmeal_bg - premeal_bg,
    bg_impact_slope = bg_impact / (premeal_bg_delay_minutes + postmeal_bg_delay_minutes)
  )
head(meals_data)
```
```{r}
extracat::visna(meals_data)
```

### Dataset highlevel view

```{r fig.width=18}
meals_data %>%
  mutate(eaten_at_hour = hour(eaten_at)) %>%
  ggplot() +
  geom_histogram(aes(x=eaten_at_hour), bins = 24) +
  facet_wrap(~user_id, ncol = 7) + 
  labs(
    title = "Distribution of hours when users had a meal"
  )
```

```{r fig.width=18}
premeal_delay_buckets = c("< 15 min", "10 - 60 min", "> 60 min")
meals_data %>%
  #filter(user_id == 2392) %>%
  #filter(premeal_bg_delay_minutes <= 300 & premeal_bg_delay_minutes >= 0) %>%
  #mutate(premeal_bg_delay = ifelse(premeal_bg_delay_minutes < 15, premeal_delay_buckets[1], ifelse(premeal_bg_delay_minutes < 60, premeal_delay_buckets[2], premeal_delay_buckets[3]))) %>%
  #mutate(premeal_bg_delay = fct_relevel(premeal_bg_delay, premeal_delay_buckets)) %>%
  #print_df(user_id, premeal_bg_time, eaten_at, premeal_bg_delay_minutes) %>%
  ggplot() +
  #geom_bar(aes(x=premeal_bg_delay, fill=premeal_bg_delay)) +
  geom_histogram(aes(x=premeal_bg_delay_minutes), binwidth = 30) +
  scale_x_continuous(breaks=c(0, 60, 120, 180, 240, 300), labels = c("0", "1h", "2h", "3h", "4h", "5h"), limits = c(0, 300)) + 
  facet_wrap(~user_id, ncol = 7, scales = "free_y") + 
  labs(
    title = "Delay of premeal BG recordings, bucketed"
  ) + 
  theme(
    legend.position="top",
    #axis.title.x = element_blank(),
    #axis.text.x = element_blank(),
    #axis.ticks.x = element_blank()
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
```

```{r fig.width=18}
postmeal_delay_buckets = c("< 1 hour", "1 - 2 hours", "> 2 hours")
meals_data %>%
  #mutate(postmeal_bg_delay = ifelse(postmeal_bg_delay_minutes < 60, postmeal_delay_buckets[1], ifelse(postmeal_bg_delay_minutes < 120, postmeal_delay_buckets[2], postmeal_delay_buckets[3]))) %>%
  #mutate(postmeal_bg_delay = fct_relevel(postmeal_bg_delay, postmeal_delay_buckets)) %>%
  #print_df(user_id, eaten_at, postmeal_bg_time, postmeal_bg_delay_minutes) %>%
  ggplot() +
  #geom_bar(aes(x=postmeal_bg_delay, fill=postmeal_bg_delay)) +
  geom_histogram(aes(x=postmeal_bg_delay_minutes), binwidth = 30) +
  #geom_density(aes(x = postmeal_bg_delay_minutes)) +
  facet_wrap(~user_id, ncol = 7) + 
  scale_x_continuous(breaks=c(0, 60, 120, 180, 240, 300), labels = c("0", "1h", "2h", "3h", "4h", "5h"), limits = c(0, 300)) + 
  labs(
    title = "Delay of postmeal BG recordings, bucketed"
  ) + 
  theme(
    legend.position="top",
    axis.title.x = element_blank(),
    #axis.text.x = element_blank(),
    #axis.ticks.x = element_blank()
    #axis.title.y = element_blank(),
    #axis.text.y = element_blank(),
    #axis.ticks.y = element_blank()
  )
```

```{r fig.height=12, fig.width=6}
meals_data %>%
  ggplot() +
  geom_boxplot(aes(x = user_id, y = premeal_bg_delay_minutes), varwidth = TRUE) + 
  scale_y_continuous(breaks=c(0, 15, 30, 45, 60), labels = c("0", "15min", "30min", "45min", "1h"), limits = c(0, 60)) + 
  coord_flip() +
  labs( title = "" )
```

```{r fig.height=12, fig.width=6}
meals_data %>%
  ggplot() +
  geom_boxplot(aes(x = user_id, y = postmeal_bg_delay_minutes), varwidth = TRUE) + 
  scale_y_continuous(breaks=c(0, 60, 120, 180, 240), labels = c("0", "1h", "2h", "3h", "4h"), limits = c(0, 1000)) + 
  coord_flip() +
  labs( title = "" )
```



## Per user analysis

```{r}
focus_user_id = "1821"
```

```{r fig.width=18, fig.height=18}
library(lattice) #sploms

meals_data %>%
  filter(user_id == focus_user_id) %>%
  mutate(
    protein_fat=eval_proportion_protein-eval_proportion_fat, 
    protein_carb=eval_proportion_protein-eval_proportion_carbs, 
    carb_fat=eval_proportion_carbs-eval_proportion_fat) %>%
  select(calories_eval, carbs_eval, fat_eval, protein_eval, fiber_eval, premeal_bg, postmeal_bg, bg_impact, protein_fat, protein_carb, carb_fat) %>%
  splom()
```

```{r fig.width=18, fig.height=18}
library(lattice) #sploms

meals_data %>%
  filter(user_id == focus_user_id) %>%
  mutate(
    protein_fat_log_ratio=log(eval_proportion_protein/(eval_proportion_fat+0.0000001)), 
    protein_carb_log_ratio=log(eval_proportion_protein/(eval_proportion_carbs+0.0000001)), 
    carb_fat_log_ratio=log(eval_proportion_carbs/(eval_proportion_fat+0.0000001))
  ) %>%
  select(eval_calories_computed, eval_proportion_carbs, eval_proportion_fat, eval_proportion_protein, premeal_bg, postmeal_bg, bg_impact, protein_fat_log_ratio, protein_carb_log_ratio, carb_fat_log_ratio) %>%
  splom()
```
Talking points:

* Correlation between calories_eval and all carbs|fat|protein, but much smaller correlation to fiber
* premeal_bg and postmeal_bg - positively correlated
* negative correlation between eval_proportion_carbs & eval_proportion_fat
* interactions between ..._log_ratio varables split the meals into 2 or 3 clusters


### Time effect

```{r}
meals_data %>% 
  filter(user_id == focus_user_id) %>%
  ggplot() +
  geom_segment(aes(x = -premeal_bg_delay_minutes, xend = postmeal_bg_delay_minutes, y=premeal_bg, yend=postmeal_bg), alpha = 0.5) + 
  scale_x_continuous(breaks=c(-15, 0, 60, 120, 180, 240), labels = c("-15min", "0", "1h", "2h", "3h", "4h"), limits = c(-15, 180))

```

```{r fig.height=5, fig.width=9}
display_meals <- function(df, ncol = 6, nrow = 3, rotate = 0) {
  meals = df[1:(ncol*nrow), ] %>% select(user_id, meal_id)
  filenames = paste0(normalizePath("~/Dropbox/MealyzerData"), "/", meals[["user_id"]], "/images/medium/", meals[["meal_id"]], ".jpg")
  #print(filenames)
  data_uris = sapply(filenames, knitr::image_uri)
  images = tibble(src = data_uris)
  r2d3(data=images, script = "display_meals.js", container = "div", options=list(ncol=ncol, nrow=nrow, rotate=rotate))
}

meals_data %>%
  filter(user_id == focus_user_id) %>%
  arrange(desc(calories_eval)) %>%
  #print_df(bg_impact, title, ingredients, calories_eval) %>%
  display_meals(ncol = 6, nrow = 4, rotate = 0)
```
```{r}
meals_data %>%
  filter(user_id == focus_user_id) %>%
  arrange(calories_eval) %>%
  #print_df(bg_impact, title, ingredients, calories_eval) %>%
  display_meals(ncol = 6, nrow = 4, rotate = 0)
```


### Plotting activeness vs. bg level

```{r}
bg_readings %>%
  group_by(meal_id) %>%
  mutate(change_in_bg = c(0,diff(bg)/first(bg))) %>%
  select(user_id, change_in_bg) %>%
  filter(change_in_bg != 0) %>%
  group_by(user_id) %>%
  summarise(n = n(), avg_change_in_bg = mean(change_in_bg))  %>%
  mutate(activeness = ifelse(n > median(n), "high","low"))  %>%
  ggplot(aes(x=seq_along(avg_change_in_bg), y=avg_change_in_bg)) +
  geom_point(aes(colour=activeness)) 
```


### Plotting pre/post meal bg, without faceting

```{r}
meals_data %>%
  select(user_id, meal_id, kind, premeal_bg, postmeal_bg) %>%
  drop_na() %>%
  ggplot(aes(x=premeal_bg, y=postmeal_bg, col=kind)) + geom_point(size=0.3) + geom_abline(intercept = 0, slope = 1, alpha=0.3)
```

### Plotting pre/post meal bg, faceting on user_id

```{r}
meals_data %>%
  select(user_id, meal_id, kind, premeal_bg, postmeal_bg) %>%
  drop_na() %>%
  ggplot(aes(x=premeal_bg, y=postmeal_bg, col=kind)) + geom_point(size=0.3) + geom_abline(intercept = 0, slope = 1, alpha=0.3) +
  facet_wrap(~user_id, ncol=7)  
```

From the above charts we see the patterns of premeal and postmeal bg level for each user, and the color shows the kind of meals for the specific meal. When we see linear trends, we interpret it as the user has similar bg level even after meals. 

### Plotting pre/post meal bg, with trends based on meal kinds, faceting on user_id

```{r}
meals_data %>%
  select(user_id, meal_id, kind, premeal_bg, postmeal_bg) %>%
  drop_na() %>%
  ggplot(aes(x=premeal_bg, y=postmeal_bg, col=kind)) + geom_point(size=0.3) + geom_smooth(method=lm, se=FALSE) +
  facet_wrap(~user_id, ncol=7)  
```


### The average BG impact for each meal kind, faceting on user_id

```{r}
#  filter(user_id==88 && meals_kind == "breakfast") 
#  filter(user_id==1883) %> summarise(n())

meals_data %>%
  filter(eaten_at < "2019-04-01") %>%
  select(user_id, meal_id, kind, bg_impact) %>%
  drop_na() %>%
  group_by(user_id, kind) %>%
  filter(length(bg_impact)>5) %>%
# summarise(h=length(bg_impact))
  summarise(avgimpact=sum(bg_impact)/length(bg_impact)) %>%
  ggplot(aes(x=kind,y=avgimpact)) + geom_col() +
  facet_wrap(~user_id, ncol=7) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#bg_readings %>%
# filter(user_id==56 && meal_id==602) non exist in bg_readings
#  filter(user_id==1665 & meal_id==2399)

meals_data %>%
  filter(eaten_at < "2019-04-01") %>%
  select(user_id, meal_id, kind, bg_impact) %>%
  drop_na() %>% #getting rid of the ones without bg impact 
  filter(user_id==1665 & kind == "breakfast")
```

### Plotting pre/post meal bg, we look at breakfast only, faceting on user_id

```{r}
meals_data %>%
  select(user_id, meal_id, kind, premeal_bg, postmeal_bg) %>%
  drop_na() %>%
  filter(kind =="breakfast") %>%
  ggplot(aes(x=premeal_bg, y=postmeal_bg, col=kind)) + geom_point(size=0.3) + geom_smooth(method=lm, se=FALSE, color="grey") +
  facet_wrap(~user_id, ncol=7)
```


### Total Calories Intake by Day
```{r}
meals_data %>%
  mutate(eaten_at_date = as.Date(eaten_at, tz = "EST")) %>%
  filter(eaten_at_date <"2019-04-01") %>%
  group_by(user_id,kind) %>%
  #filter(length(meal_id)>5) %>%
  group_by(user_id, eaten_at_date) %>%
  summarise(sum_by_day = sum(calories_eval)) %>%
  ggplot(aes(x=eaten_at_date, y=sum_by_day))+
  geom_point(size=0.3)+
  geom_smooth(method = "lm", size=0.8)+
  facet_wrap(~user_id, ncol=7)
```

### Calories by Meal
```{r}
meals_data %>%
  mutate(eaten_at_date = as.Date(eaten_at, tz = "EST")) %>%
  filter(eaten_at_date <"2019-04-01") %>%
  group_by(user_id,kind) %>%
  #filter(user_id==1883) %>%
  #summarise(n())
  filter(length(meal_id)>5) %>%
  #group_by(user_id, eaten_at_date,kind) %>%
  #summarise(sum_by_day = sum(calories_eval)) %>%
  ggplot(aes(x=eaten_at_date, y=calories_eval, col=kind))+
  geom_point(size=0.3)+
  geom_smooth(method = "lm",se= F, size=0.8)+
  facet_wrap(~user_id, ncol=7)
```

```{r}
dplyr::summarise(group_by(meals_data, user_id, kind), freq = n()) %>%
  group_by(user_id) %>%
  mutate(prop = freq/sum(freq)) %>%
  ungroup() %>%
  ggplot(aes(x = user_id, y = prop, fill = forcats::fct_rev(kind))) +
      geom_bar(stat = "identity") + 
      coord_flip() + 
      labs(x = "User ID",
           y = "Proportion",
           title = "Proportion of All Meals by Meal Kind") + 
           theme(legend.title = element_blank(), legend.position="bottom") +
  guides(fill = guide_legend(nrow = 1, reverse=T))
```
```{r}
# Proportion of Meals by Nutrient - Expert Evaluation
meals_data %>%
  #filter(kind %in% c("dinner","breakfast")) %>%
  #filter(eaten_at < "2019-01-10") %>%
  select(user_id,carbs_eval, protein_eval,fat_eval,fiber_eval) %>%
  gather(key = "variable", value, -user_id) %>%
  group_by(user_id, variable) %>%
  summarise(total=sum(value, na.rm = T)) %>%
  group_by(user_id) %>%
  mutate(prop = total/sum(total)) %>%
  ungroup() %>%
  ggplot(aes(x = user_id, y = prop, fill = forcats::fct_rev(variable))) +
      geom_bar(stat = "identity") + 
      coord_flip() + 
      labs(x = "User ID",
           y = "Proportion",
           title = "Proportion of All Meals by Nutrient - Expert Evaluation") + 
           theme(legend.title = element_blank(), legend.position="bottom") +
  guides(fill = guide_legend(nrow = 1, reverse=T))

# Proportion of Meals by Nutrient - Self Evaluation
meals_data %>%
  select(user_id,carbs_user, protein_user,fat_user,fiber_user) %>%
  gather(key = "variable", value, -user_id) %>%
  group_by(user_id, variable) %>%
  summarise(total=sum(value, na.rm = T)) %>%
  group_by(user_id) %>%
  mutate(prop = total/sum(total)) %>%
  ungroup() %>%
  ggplot(aes(x = user_id, y = prop, fill = forcats::fct_rev(variable))) +
      geom_bar(stat = "identity") + 
      coord_flip() + 
      labs(x = "User ID",
           y = "Proportion",
           title = "Proportion of All Meals by Nutrient - Self Evaluation") + 
           theme(legend.title = element_blank(), legend.position="bottom") +
  guides(fill = guide_legend(nrow = 1, reverse=T))
```


```{r}
parcoords(
  meals_data %>% 
    select(kind,carbs_eval, protein_eval,fat_eval,fiber_eval,calories_eval, bg_impact)
  , rownames = F # turn off rownames from the data.frame
  , brushMode = "1D-axes"
  , reorderable = T
  , queue = T,
  alpha = 0.05,
  color = list(
      colorBy = "kind"
      , colorScale = "scaleOrdinal"
      , colorScheme = "schemeCategory10"
    )
  , withD3 = TRUE
)
```
```{r}
parcoords(
  meals_data %>% 
    select(user_id, kind, bg_impact, calories_eval, carbs_eval, protein_eval,fat_eval,fiber_eval) %>%
    gather(key = "variable", value, -user_id,-kind) %>%
    group_by(user_id, kind, variable) %>%
    summarise(avg_eval=mean(value, na.rm = T)) %>%
    spread(variable, avg_eval)
  , rownames = F # turn off rownames from the data.frame
  , brushMode = "1D-axes"
  , reorderable = T
  , queue = T,
  alpha = 0.3,
  color = list(
      colorBy = "kind"
      , colorScale = "scaleOrdinal"
      , colorScheme = "schemeCategory10"
    )
  , withD3 = TRUE
)
```

```{r}
meals_data %>%
  select(user_id, kind,carbs_eval, protein_eval,fat_eval,fiber_eval,calories_eval, bg_impact) %>%
  mutate_if(is.numeric, scale) %>%
  mutate(ID = 1:3303) %>%
  gather(key = "variable", value, -user_id,-kind, -ID) %>% 
  ggplot(aes(x=variable,y=value,colour=kind, group=ID))+
  geom_line(alpha=0.5)+facet_wrap(~user_id,ncol=7)+
  theme(axis.text=element_text(size=5, angle = 90))
```
```{r}
meals_data %>%
  select(user_id, kind,carbs_eval, protein_eval,fat_eval,fiber_eval, bg_impact) %>%
  #mutate(ID = 1:3303) %>%
  gather(key = "variable", value, -user_id,-kind) %>%
  group_by(user_id, kind, variable) %>%
  summarise(avg_eval=mean(value, na.rm = T)) %>%
  ungroup() %>%
  mutate_if(is.numeric, scale) %>%
  #gather(key = "variable", value, -user_id,-kind, -ID, -avg_eval) %>% 
  ggplot(aes(x=variable,y=avg_eval,group=1))+
  geom_line(alpha=0.5)+
  coord_flip() +
  facet_wrap(~user_id,ncol=7)
```



```{r}
# BG level overview for all users
bg_readings %>%
  filter(time <"2019-04-01") %>%
  ggplot(aes(x=time, y=bg, color=factor(meals_kind)))+
  geom_point(size = 0.05)+
  geom_smooth(method = "lm", se=F, size=0.8)+
  facet_wrap(~user_id,ncol=7) +
  theme(axis.text=element_text(size=5, angle = 90))
```

```{r}
bg_readings %>%
  #mutate(time = round_date(time, '1 hours')) %>%
  mutate(time = format(as.POSIXct(time,format="%H:%M:%S"),"%H")) %>%
  group_by(user_id, time, readings_kind) %>%
  summarise(avg_bg = mean(bg)) %>%
  ggplot(aes(x=time, y=avg_bg, color=factor(readings_kind)))+
  geom_point(size = 0.3)+
  facet_wrap(~user_id, ncol=7) +
  labs(x="Hour", y="Average BG Level")+
  ggtitle("Average BG Level by Hour") +
  theme(plot.title = element_text(face = "bold")) +
  theme(axis.text=element_text(size=5, angle = 90))
```

```{r}
distance = read.csv("~/Dropbox/MealyzerData/1983/activities-distance_overview.csv", header=T)
calories = read.csv("~/Dropbox/MealyzerData/1983/activities-calories_overview.csv", header=T)
steps = read.csv("~/Dropbox/MealyzerData/1983/activities-steps_overview.csv", header=T)

activities <- merge(steps, merge(distance, calories, by = "date", all = TRUE), by = "date", all = TRUE)
colnames(activities) <- c("date","steps","distance","calories")

# date vs. calories,distance,steps for user #1983
activities %>% 
  mutate(date = date(as.timestamp(date))) %>%
  slice(1:133) %>% # weird data after this point
  gather(key = key, value = value, -date) %>%
  ggplot(aes(date, value, col=key)) + geom_line()

# scale the above data
activities %>% 
  mutate(date = date(as.timestamp(date))) %>%
  slice(1:133) %>% # weird data after this point
  gather(key = key, value = value, -date) %>%
  group_by(key) %>%
  mutate(index = round(100*value/value[1], 2)) %>% 
  ungroup() %>%
  ggplot(aes(date, index, col=key)) + geom_line()  

# once scaled, we see that the data for distance and steps completely overlaps, suggesting that one is a linear function of another.  
```

```{r}
user1983 = bg_readings %>%
  mutate(date=date(time)) %>%
  group_by(user_id, date) %>%
  mutate(avg_bg=mean(bg)) %>%
  select(user_id,date,avg_bg) %>%
  unique() %>%
  filter(user_id==1983) %>%
  slice(1:72) # weird data after this point

user1983 %>%
  ggplot(aes(date, avg_bg)) + geom_line()

# plot avg_bg vs. calories for user #1983
activities %>% 
  mutate(date = date(as.timestamp(date))) %>%
  full_join(user1983, by="date") %>%  #or use merge?
  select(-user_id, -distance, -steps) %>%
  filter(date < "2019-04-01") %>%
  gather(key = key, value = value, -date) %>%
  group_by(key) %>%
  mutate(index = round(100*value/value[1], 2)) %>% 
  ungroup() %>%
  ggplot(aes(date, index, col=key)) + geom_line() +
  ggtitle("Average BG Level vs. Calories Burnt for User #1983")

# We see that there are missing values for average BG, which is normal since bg level and calories burnt are measured by two different devices/apps.
# Based on the data we have here, we see that avg_bg has a negative relationship with calories burnt, where higher avg_bg usually is associated with lower calories burnt that day.
```



```{r}
#user 1983's avg_bg vs. minutesasleep by day
sleep1983 = read.csv("~/Dropbox/MealyzerData/1983/sleep_overview.csv")
sleep1983 %>%
  mutate(date=date(as.timestamp(dateOfSleep))) %>%
  arrange(date) %>% # to perform correct scaling, must have date in ascending order
  group_by(date) %>%
  mutate(minutesAsleep = sum(minutesAsleep)) %>%
  full_join(user1983, by="date") %>% #merge?
  select(date, minutesAsleep, avg_bg) %>%
  filter(date < "2019-04-01") %>%
  gather(key = key, value = value, -date) %>%
  group_by(key) %>%
  mutate(index = round(100*value/value[1], 2)) %>% 
  ungroup() %>%
  ggplot(aes(date, index, col=key)) + geom_line() +
  theme(plot.title = element_text(face = "bold")) 
```

```{r}
# user 1983's parcoords 
parcoords(
  sleep1983 %>% 
    select(-minutesToFallAsleep) %>%
    mutate(date=date(as.timestamp(dateOfSleep))) %>%
    group_by(date) %>%
    mutate(minutesAsleep = sum(minutesAsleep)) %>%
    merge(user1983, by="date") %>%
    ungroup() %>%
    select(-minutesAfterWakeup, -date, - user_id) 
  , rownames = F # turn off rownames from the data.frame
  , brushMode = "1D-axes"
  , reorderable = T
  , queue = T,
  alpha = 0.5,
  color = list(
      colorBy = "kind"
      , colorScale = "scaleOrdinal"
      , colorScheme = "schemeCategory10"
    )
  , withD3 = TRUE
)

ds =sleep1983 %>% 
    select(-minutesToFallAsleep) %>%
    mutate(date=date(as.timestamp(dateOfSleep))) %>%
    group_by(date) %>%
    mutate(minutesAsleep = sum(minutesAsleep)) %>%
    merge(user1983, by="date") %>%
    ungroup() %>%
    select(-minutesAfterWakeup, -date, - user_id) 

ggparcoord(ds, scale = "uniminmax",alpha = 0.3) +
  ggtitle("Parallel Coordinates for User #1983, uniminmax scaled") + 
  theme(plot.title = element_text(face = "bold")) 
```

```{r}
# User 1983's pre breakfast bg reading vs. amount sleep
bg1983 = bg_readings %>%
  mutate(date=date(time)) %>%
  filter(user_id==1983 & meals_kind=="breakfast" & readings_kind=="premeal")

sleep1983 %>%
  #mutate(date=as.timestamp(dateOfSleep)) %>% # different time of sleep recorded, makes a difference? 
  mutate(date=date(as.timestamp(dateOfSleep))) %>%
  arrange(date) %>% # to perform correct scaling, must have date in ascending order
  group_by(date) %>%
  mutate(minutesAsleep = sum(minutesAsleep)) %>%
  full_join(bg1983, by="date") %>% #merge?
  select(date, minutesAsleep, bg) %>%
  drop_na() %>%
  unique() %>%
  ggplot(aes(x=minutesAsleep,y=bg)) + geom_point() + geom_smooth(method=lm, se=FALSE) + 
  ggtitle("User 1983's pre breakfast bg reading vs. amount sleep") 

sleep1983 %>%
  mutate(date=date(as.timestamp(dateOfSleep))) %>%
  arrange(date) %>% # to perform correct scaling, must have date in ascending order
  group_by(date) %>%
  full_join(bg1983, by="date") %>% #merge?
  select(date, efficiency, bg) %>%
  drop_na() %>%
  unique() %>%
  ggplot(aes(x=efficiency,y=bg)) + geom_point() + geom_smooth(method=lm, se=FALSE) + 
  ggtitle("User 1983's pre breakfast bg reading vs. sleep efficiency") 

sleep1983 %>%
  mutate(date=date(as.timestamp(dateOfSleep))) %>%
  arrange(date) %>% # to perform correct scaling, must have date in ascending order
  group_by(date) %>%
  mutate(minutesAsleep = sum(minutesAsleep)) %>%
  full_join(user1983, by="date") %>% #merge?
  select(date, minutesAsleep, avg_bg) %>%
  drop_na() %>%
  unique() %>%
  ggplot(aes(x=minutesAsleep,y=avg_bg)) + geom_point() + geom_smooth(method=lm, se=FALSE) + 
  ggtitle("User 1983's avg_bg reading vs. amount sleep by day") 

meal1983 = meals_data %>%
  mutate(date=date(eaten_at)) %>%
  group_by(user_id, date) %>%
  mutate(bgimpact=sum(bg_impact)) %>%
  select(user_id,date,bgimpact) %>%
  unique() %>%
  drop_na() %>%
  filter(user_id==1983)

sleep1983 %>%
  mutate(date=date(as.timestamp(dateOfSleep))) %>%
  arrange(date) %>% # to perform correct scaling, must have date in ascending order
  group_by(date) %>%
  mutate(minutesAsleep = sum(minutesAsleep)) %>%
  full_join(meal1983, by="date") %>% #merge?
  select(date, minutesAsleep, bgimpact) %>%
  drop_na() %>%
  unique() %>%
  ggplot(aes(x=minutesAsleep,y=bgimpact)) + geom_point() + geom_smooth(method=lm, se=FALSE) + 
  ggtitle("User 1983's bg impact vs. amount sleep by day") 
```

```{r}
bg1665 = bg_readings %>%
  mutate(date=date(time)) %>%
  filter(user_id==1665 & meals_kind=="breakfast" & readings_kind=="premeal")

#user 1665's bg vs. minutesasleep by day
sleep1665 = read.csv("~/Dropbox/MealyzerData/1665/sleep_overview.csv")
sleep1665 %>%
  #mutate(date=as.timestamp(dateOfSleep)) %>% # different time of sleep recorded, makes a difference? 
  mutate(date=date(as.timestamp(dateOfSleep))) %>%
  arrange(date) %>% # to perform correct scaling, must have date in ascending order
  group_by(date) %>%
  mutate(minutesAsleep = sum(minutesAsleep)) %>%
  full_join(bg1665, by="date") %>% #merge?
  select(date, minutesAsleep, bg) %>%
  drop_na() %>%
  unique() %>%
  ggplot(aes(x=minutesAsleep,y=bg)) + geom_point() + geom_smooth(method=lm, se=FALSE) + 
  ggtitle("User 1665's pre breakfast bg reading vs. amount sleep") 

sleep1665 %>%
  mutate(date=date(as.timestamp(dateOfSleep))) %>%
  arrange(date) %>% # to perform correct scaling, must have date in ascending order
  group_by(date) %>%
  full_join(bg1665, by="date") %>% #merge?
  select(date, efficiency, bg) %>%
  drop_na() %>%
  unique() %>%
  ggplot(aes(x=efficiency,y=bg)) + geom_point() + geom_smooth(method=lm, se=FALSE) + 
  ggtitle("User 1665's pre breakfast bg reading vs. sleep efficiency") 

user1665 = bg_readings %>%
  mutate(date=date(time)) %>%
  group_by(user_id, date) %>%
  mutate(avg_bg=mean(bg)) %>%
  select(user_id,date,avg_bg) %>%
  unique() %>%
  filter(user_id==1665)

#user 1665's avg_bg vs. minutesasleep by day
sleep1665 %>%
  mutate(date=date(as.timestamp(dateOfSleep))) %>%
  arrange(date) %>% # to perform correct scaling, must have date in ascending order
  group_by(date) %>%
  mutate(minutesAsleep = sum(minutesAsleep)) %>%
  full_join(user1665, by="date") %>% #merge?
  select(date, minutesAsleep, avg_bg) %>%
  drop_na() %>%
  unique() %>%
  ggplot(aes(x=minutesAsleep,y=avg_bg)) + geom_point() + geom_smooth(method=lm, se=FALSE) + 
  ggtitle("User 1665's avg_bg reading vs. amount sleep by day") 

meal1665 = meals_data %>%
  mutate(date=date(eaten_at)) %>%
  group_by(user_id, date) %>%
  mutate(bgimpact=sum(bg_impact)) %>%
  select(user_id,date,bgimpact) %>%
  unique() %>%
  drop_na() %>%
  filter(user_id==1665)

sleep1665 %>%
  mutate(date=date(as.timestamp(dateOfSleep))) %>%
  arrange(date) %>% # to perform correct scaling, must have date in ascending order
  group_by(date) %>%
  mutate(minutesAsleep = sum(minutesAsleep)) %>%
  full_join(meal1665, by="date") %>% #merge?
  select(date, minutesAsleep, bgimpact) %>%
  drop_na() %>%
  unique() %>%
  ggplot(aes(x=minutesAsleep,y=bgimpact)) + geom_point() + geom_smooth(method=lm, se=FALSE) + 
  ggtitle("User 1665's bg impact vs. amount sleep by day") 
```

```{r}
bg1883 = bg_readings %>%
  mutate(date=date(time)) %>%
  filter(user_id==1883 & meals_kind=="breakfast" & readings_kind=="premeal")

#user 1883's bg vs. minutesasleep by day
sleep1883 = read.csv("~/Dropbox/MealyzerData/1883/sleep_overview.csv")
sleep1883 %>%
  #mutate(date=as.timestamp(dateOfSleep)) %>% # different time of sleep recorded, makes a difference? 
  mutate(date=date(as.timestamp(dateOfSleep))) %>%
  arrange(date) %>% # to perform correct scaling, must have date in ascending order
  group_by(date) %>%
  mutate(minutesAsleep = sum(minutesAsleep)) %>%
  full_join(bg1883, by="date") %>% #merge?
  select(date, minutesAsleep, bg) %>%
  drop_na() %>%
  unique() %>%
  ggplot(aes(x=minutesAsleep,y=bg)) + geom_point() + geom_smooth(method=lm, se=FALSE) + 
  ggtitle("User 1883's pre breakfast bg reading vs. amount sleep") 

user1883 = bg_readings %>%
  mutate(date=date(time)) %>%
  group_by(user_id, date) %>%
  mutate(avg_bg=mean(bg)) %>%
  select(user_id,date,avg_bg) %>%
  unique() %>%
  filter(user_id==1883)

#user 1883's avg_bg vs. minutesasleep by day
sleep1883 %>%
  mutate(date=date(as.timestamp(dateOfSleep))) %>%
  arrange(date) %>% # to perform correct scaling, must have date in ascending order
  group_by(date) %>%
  mutate(minutesAsleep = sum(minutesAsleep)) %>%
  full_join(user1883, by="date") %>% #merge?
  select(date, minutesAsleep, avg_bg) %>%
  drop_na() %>%
  unique() %>%
  ggplot(aes(x=minutesAsleep,y=avg_bg)) + geom_point() + geom_smooth(method=lm, se=FALSE) + 
  ggtitle("User 1883's avg_bg reading vs. amount sleep by day") 

meal1883 = meals_data %>%
  mutate(date=date(eaten_at)) %>%
  group_by(user_id, date) %>%
  mutate(bgimpact=sum(bg_impact)) %>%
  select(user_id,date,bgimpact) %>%
  unique() %>%
  drop_na() %>%
  filter(user_id==1883)

sleep1883 %>%
  mutate(date=date(as.timestamp(dateOfSleep))) %>%
  arrange(date) %>% # to perform correct scaling, must have date in ascending order
  group_by(date) %>%
  mutate(minutesAsleep = sum(minutesAsleep)) %>%
  full_join(meal1883, by="date") %>% #merge?
  select(date, minutesAsleep, bgimpact) %>%
  drop_na() %>%
  unique() %>%
  ggplot(aes(x=minutesAsleep,y=bgimpact)) + geom_point() + geom_smooth(method=lm, se=FALSE) + 
  ggtitle("User 1883's bg impact vs. amount sleep by day") 
```

```{r}
bg1809 = bg_readings %>%
  mutate(date=date(time)) %>%
  filter(user_id==1809 & meals_kind=="breakfast" & readings_kind=="premeal")

#user 1809's bg vs. minutesasleep by day
sleep1809 = read.csv("~/Dropbox/MealyzerData/1809/sleep_overview.csv")
sleep1809 %>%
  #mutate(date=as.timestamp(dateOfSleep)) %>% # different time of sleep recorded, makes a difference? 
  mutate(date=date(as.timestamp(dateOfSleep))) %>%
  arrange(date) %>% # to perform correct scaling, must have date in ascending order
  group_by(date) %>%
  mutate(minutesAsleep = sum(minutesAsleep)) %>%
  full_join(bg1809, by="date") %>% #merge?
  select(date, minutesAsleep, bg) %>%
  drop_na() %>%
  unique() %>%
  ggplot(aes(x=minutesAsleep,y=bg)) + geom_point() + geom_smooth(method=lm, se=FALSE) + 
  ggtitle("User 1809's pre breakfast bg reading vs. amount sleep") 

user1809 = bg_readings %>%
  mutate(date=date(time)) %>%
  group_by(user_id, date) %>%
  mutate(avg_bg=mean(bg)) %>%
  select(user_id,date,avg_bg) %>%
  unique() %>%
  filter(user_id==1809)

#user 1809's avg_bg vs. minutesasleep by day
sleep1809 %>%
  mutate(date=date(as.timestamp(dateOfSleep))) %>%
  arrange(date) %>% # to perform correct scaling, must have date in ascending order
  group_by(date) %>%
  mutate(minutesAsleep = sum(minutesAsleep)) %>%
  full_join(user1809, by="date") %>% #merge?
  select(date, minutesAsleep, avg_bg) %>%
  drop_na() %>%
  unique() %>%
  ggplot(aes(x=minutesAsleep,y=avg_bg)) + geom_point() + geom_smooth(method=lm, se=FALSE) + 
  ggtitle("User 1809's avg_bg reading vs. amount sleep by day") 

meal1809 = meals_data %>%
  mutate(date=date(eaten_at)) %>%
  group_by(user_id, date) %>%
  mutate(bgimpact=sum(bg_impact)) %>%
  select(user_id,date,bgimpact) %>%
  unique() %>%
  drop_na() %>%
  filter(user_id==1809)

sleep1809 %>%
  mutate(date=date(as.timestamp(dateOfSleep))) %>%
  arrange(date) %>% # to perform correct scaling, must have date in ascending order
  group_by(date) %>%
  mutate(minutesAsleep = sum(minutesAsleep)) %>%
  full_join(meal1809, by="date") %>% #merge?
  select(date, minutesAsleep, bgimpact) %>%
  drop_na() %>%
  unique() %>%
  ggplot(aes(x=minutesAsleep,y=bgimpact)) + geom_point() + geom_smooth(method=lm, se=FALSE) + 
  ggtitle("User 1809's bg impact vs. amount sleep by day") 
```


```{r}
bg1821 = bg_readings %>%
  mutate(date=date(time)) %>%
  filter(user_id==1821 & meals_kind=="breakfast" & readings_kind=="premeal")

#user 1821's bg vs. minutesasleep by day
sleep1821 = read.csv("~/Dropbox/MealyzerData/1821/sleep_overview.csv")
sleep1821 %>%
  #mutate(date=as.timestamp(dateOfSleep)) %>% # different time of sleep recorded, makes a difference? 
  mutate(date=date(as.timestamp(dateOfSleep))) %>%
  arrange(date) %>% # to perform correct scaling, must have date in ascending order
  group_by(date) %>%
  mutate(minutesAsleep = sum(minutesAsleep)) %>%
  full_join(bg1821, by="date") %>% #merge?
  select(date, minutesAsleep, bg) %>%
  drop_na() %>%
  unique() %>%
  ggplot(aes(x=minutesAsleep,y=bg)) + geom_point() + geom_smooth(method=lm, se=FALSE) + 
  ggtitle("User 1821's pre breakfast bg reading vs. amount sleep") 

user1821 = bg_readings %>%
  mutate(date=date(time)) %>%
  group_by(user_id, date) %>%
  mutate(avg_bg=mean(bg)) %>%
  select(user_id,date,avg_bg) %>%
  unique() %>%
  filter(user_id==1821)

#user 1821's avg_bg vs. minutesasleep by day
sleep1821 %>%
  mutate(date=date(as.timestamp(dateOfSleep))) %>%
  arrange(date) %>% # to perform correct scaling, must have date in ascending order
  group_by(date) %>%
  mutate(minutesAsleep = sum(minutesAsleep)) %>%
  full_join(user1821, by="date") %>% #merge?
  select(date, minutesAsleep, avg_bg) %>%
  drop_na() %>%
  unique() %>%
  ggplot(aes(x=minutesAsleep,y=avg_bg)) + geom_point() + geom_smooth(method=lm, se=FALSE) + 
  ggtitle("User 1821's avg_bg reading vs. amount sleep by day") 

meal1821 = meals_data %>%
  mutate(date=date(eaten_at)) %>%
  group_by(user_id, date) %>%
  mutate(bgimpact=sum(bg_impact)) %>%
  select(user_id,date,bgimpact) %>%
  unique() %>%
  drop_na() %>%
  filter(user_id==1821)

sleep1821 %>%
  mutate(date=date(as.timestamp(dateOfSleep))) %>%
  arrange(date) %>% # to perform correct scaling, must have date in ascending order
  group_by(date) %>%
  mutate(minutesAsleep = sum(minutesAsleep)) %>%
  full_join(meal1821, by="date") %>% #merge?
  select(date, minutesAsleep, bgimpact) %>%
  drop_na() %>%
  unique() %>%
  ggplot(aes(x=minutesAsleep,y=bgimpact)) + geom_point() + geom_smooth(method=lm, se=FALSE) + 
  ggtitle("User 1821's bg impact vs. amount sleep by day") 
```







