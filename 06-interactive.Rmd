---
title: "Shiny Report"
output: 
  flexdashboard::flex_dashboard:
    theme: flatly
runtime: shiny
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(forcats)
library(r2d3)
library(parcoords)
library(dplyr)
library(GGally)
library(flexdashboard)
library(shiny)
library(rmarkdown)
library(knitr)
library(Hmisc)
library(shinythemes)


assignInNamespace("cedta.override", c(data.table:::cedta.override,"rmarkdown"), "data.table")

opts_chunk$set(echo = FALSE, comment="", warning = FALSE, message = FALSE, tidy.opts=list(width.cutoff=55), tidy = TRUE)

```




```{r}
# Data Import
raw_data_path = "~/Dropbox/MealyzerData"
mealyser_data_overview = read_csv(file.path(raw_data_path, "mealyzer_data_overview.csv"), col_types = cols())
```




```{r}
# Selecting users for the analysis
users = mealyser_data_overview %>%
  filter(complete_meals > 14)
#print(users[["user_id"]])
```

```{r}
read_mealyzer_files <- function(data_dir, user_ids, file_name, add_user_id, col_types) {
  result <- c()
  for (user_id in user_ids) {
    
    file_path = file.path(data_dir, as.character(user_id), file_name)
    df = read_csv(file_path, col_types = col_types)
    if (add_user_id) {
      df = cbind(user_id = user_id, df)
    }
    if (length(result) == 0) {
      result <- df
    } else {
      result <- rbind(result, df)
    }
  }
  return(result)
}

as.timestamp <- function(minutes_since, anchor_date = '2019-01-01 00:00:00 EST') {
  anchor_time = as.POSIXct(anchor_date)
  return(anchor_time + minutes_since * 60)
}

as.meals_kind <- function(values) {
  return(fct_relevel(values, c("breakfast", "morning_snack", "lunch", "afternoon_snack", "dinner", "after_dinner_snack")))
}

print_df <- function(df, ...) {
  print(df %>% select(...))
  return(df)
}

```

```{r}
bg_readings = read_mealyzer_files(raw_data_path, users[["user_id"]], "bg_labeled.csv", add_user_id = TRUE, col_types = cols(
  time = col_double(),
  bg = col_double(),
  meals_kind = col_character(),
  meal_id = col_double(),
  readings_kind = col_character()
)) %>%
  mutate(
    user_id = as.character(user_id),
    time = as.timestamp(time), 
    meals_kind = as.meals_kind(meals_kind),
    readings_kind = fct_relevel(readings_kind, c("premeal", "postmeal"))
  )
meals_data = read_mealyzer_files(raw_data_path, users[["user_id"]], "mealyzer_data.csv", add_user_id = FALSE, col_types = cols()) %>%
  mutate(
    user_id = as.character(user_id),
    eaten_at = as.timestamp(eaten_at),
    kind = as.meals_kind(kind),
    premeal_bg_time = as.timestamp(premeal_bg_time),
    postmeal_bg_time = as.timestamp(postmeal_bg_time),
    premeal_bg_delay_minutes = as.double(difftime(eaten_at, premeal_bg_time, units = "mins")),
    postmeal_bg_delay_minutes = as.double(difftime(postmeal_bg_time, eaten_at, units = "mins")),
    bg_impact = postmeal_bg - premeal_bg,
    bg_impact_slope = bg_impact / (premeal_bg_delay_minutes + postmeal_bg_delay_minutes)
  )
#head(meals_data)
```



```{r constants}
users <- mealyser_data_overview %>%
  filter(complete_meals > 14)
user_list <- as.character(users[["user_id"]])

meal_kind <- as.character(unique(meals_data[["kind"]]))
```


Introduction
=====================================  

We are analyzing data from a proprietary application which allows users to record their blood glucose level before and after a meal, what they eat for a meal, the estimation of calories intake, activity & sleep data from fitbit, and images of what user consumes for each meal. 


Click on the tabs to see different reports.


Nutrient Proportion
===================================


Row {data-height=500}
-------------------------------------

```{r respondents}
inputPanel(
  selectInput(inputId="user_id_tab", label = "Select Users:", choices = user_list, selected = user_list, multiple = TRUE),
  selectInput(inputId="meal_kind_tab", label = "Select Meal Type:", choices = meal_kind, selected = meal_kind, multiple = TRUE), 
  dateRangeInput(inputId="date_range_tab", label= "Select Date Range:", start = "2019-01-01", end = "2019-06-01", min = "2019-01-01",
  max = "2019-06-01", format = "yyyy-mm-dd", startview = "month",
  weekstart = 0, language = "en", separator = " to ", width = NULL,
  autoclose = TRUE)
)
```

## Column 1

```{r}
renderPlot({
  # Proportion of Meals by Nutrient - Expert Evaluation
  meals_data %>%
    filter(user_id %in% input$user_id_tab) %>%
    filter(kind %in% input$meal_kind_tab) %>%
    filter(eaten_at >= input$date_range_tab[1] & eaten_at <= input$date_range_tab[2]) %>%
    select(user_id,carbs_eval, protein_eval,fat_eval,fiber_eval) %>%
    gather(key = "variable", value, -user_id) %>%
    group_by(user_id, variable) %>%
    summarise(total=sum(value, na.rm = T)) %>%
    group_by(user_id) %>%
    mutate(prop = total/sum(total)) %>%
    ungroup() %>%
    ggplot(aes(x = user_id, y = prop, fill = forcats::fct_rev(variable))) +
        geom_bar(stat = "identity") + 
        coord_flip() + 
        labs(x = "User ID",
             y = "Proportion",
             title = "Proportion of All Meals by Nutrient - Expert Evaluation") + 
             theme(plot.title = element_text(face = "bold"), legend.title = element_blank(), legend.position="bottom") +
    guides(fill = guide_legend(nrow = 1, reverse=T))
})

```


## Column 2
```{r}
renderPlot({
  # Proportion of Meals by Nutrient - Self Evaluation
  meals_data %>%
    filter(user_id %in% input$user_id_tab) %>%
    filter(kind %in% input$meal_kind_tab) %>%
    filter(eaten_at >= input$date_range_tab[1] & eaten_at <= input$date_range_tab[2]) %>%
    select(user_id,carbs_user, protein_user,fat_user,fiber_user) %>%
    gather(key = "variable", value, -user_id) %>%
    group_by(user_id, variable) %>%
    summarise(total=sum(value, na.rm = T)) %>%
    group_by(user_id) %>%
    mutate(prop = total/sum(total)) %>%
    ungroup() %>%
    ggplot(aes(x = user_id, y = prop, fill = forcats::fct_rev(variable))) +
        geom_bar(stat = "identity") + 
        coord_flip() + 
        labs(x = "User ID",
             y = "Proportion",
             title = "Proportion of All Meals by Nutrient - Self Evaluation") + 
             theme(plot.title = element_text(face = "bold"), legend.title = element_blank(), legend.position="bottom") +
    guides(fill = guide_legend(nrow = 1, reverse=T))
})

```


Daily Intake of Calories
===================================


Row {data-height=500}
-------------------------------------

```{r}
inputPanel(
  selectInput(inputId="meal_kind_tab2", label = "Select Meal Type:", choices = meal_kind, selected = meal_kind, multiple = TRUE), 
  dateRangeInput(inputId="date_range_tab2", label= "Select Date Range:", start = "2019-01-01", end = "2019-06-01", min = "2019-01-01",
  max = "2019-06-01", format = "yyyy-mm-dd", startview = "month",
  weekstart = 0, language = "en", separator = " to ", width = NULL,
  autoclose = TRUE)
)

renderPlot({
  meals_data %>%
    filter(kind %in% input$meal_kind_tab2) %>%
    filter(eaten_at >= input$date_range_tab2[1] & eaten_at <= input$date_range_tab2[2]) %>%
    mutate(eaten_at_date = as.Date(eaten_at, tz = "EST")) %>%
    group_by(user_id, eaten_at_date) %>%
    summarise(sum_by_day = sum(calories_eval)) %>%
    ggplot(aes(x=eaten_at_date, y=sum_by_day))+
    geom_point(size=0.3)+
    geom_smooth(method = "lm")+
    facet_wrap(~user_id, ncol=7) +
    labs(x = "Date",
               y = "Calories Intake",
               title = "Total Calories Intake by Day") +
    theme(plot.title = element_text(face = "bold"))
})
```


Blood Glucose Levels by Hour
===================================


Row {data-height=500}
-------------------------------------
```{r}
inputPanel(
  selectInput(inputId="meal_kind_tab3", label = "Select Meal Type:", choices = meal_kind, selected = meal_kind, multiple = TRUE), 
  dateRangeInput(inputId="date_range_tab3", label= "Select Date Range:", start = "2019-01-01", end = "2019-06-01", min = "2019-01-01",
  max = "2019-06-01", format = "yyyy-mm-dd", startview = "month",
  weekstart = 0, language = "en", separator = " to ", width = NULL,
  autoclose = TRUE)
)

renderPlot({
  bg_readings %>%
    filter(meals_kind %in% input$meal_kind_tab3) %>%
    filter(time >= input$date_range_tab3[1] & time <= input$date_range_tab3[2]) %>%
    #mutate(time = round_date(time, '1 hours')) %>%
    mutate(time = format(as.POSIXct(time,format="%H:%M:%S"),"%H")) %>%
    group_by(user_id, time) %>%
    summarise(avg_bg = mean(bg)) %>%
    ggplot(aes(x=time, y=avg_bg))+
    geom_point(size=1)+
    facet_wrap(~user_id, ncol=7) +
    labs(x="Hour", y="Average BG Level")+
    ggtitle("Average BG Level by Hour") +
    theme(plot.title = element_text(face = "bold")) +
    theme(axis.text=element_text(size=5, angle = 90))
})

```


