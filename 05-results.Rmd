# Results

Below are some of the visualizations selected to highlight interesting insights about the data. Not all visualizations we tried were insightful or had any talking points and those are not included in themain results section. Some of those plots ended up in the appendix section.

We heavily utilized facets to highlight patterns and differences between users. These faceted plots allow just a glimpse of individual user stats but mainly focus on the contrast and comparison between users. In order to facilitate comparison of same user across different plots we maintained consistent placement of users on the facet grid, so that the same user consistently appers in the same position on all faceted plots.

Analyzing combinied data for multiple users did not yield any interesting insights, as the dataset contains few users and user bevaviours are different enough that in aggregate the interesting patterns get lost.

## Looking at the time of the meals

```{r fig.width=4}
meals.selected %>%
  mutate(eaten_at_hour = hour(eaten_at)) %>%
  ggplot() +
  geom_histogram(aes(x=eaten_at_hour), bins = 24, fill = "#4285FF") +
  facet_wrap(~user_fct, ncol = 6) + 
  labs(
    title = "Time of day when users had a meal",
    x = "Hour of day",
    y = "Number of meals"
  ) + 
  theme(
    #strip.text = element_text(size=25)
  )
```

Interesting to node the different pattern that can be seen. The are users (like 2004, 2262, 2392, 24, 2475, 2890, 56, 57, 58) who have a well defined 3 humps pattern. THose users tend to eat their 3 meals of the day at regular times. The users 2942, 2948, 2800 have a defined 2 hump pattern, eating only 2 meals a day. And then there are "grazers" like users 2254, 2536 who seem to be eating either all the time or with no consistent times.

For those "two meals" user, what meal of the day are they skipping? Lets analyze the meal kinds per user.

## Meal kind analysis

```{r fig.width=4}
meals.selected %>%
  group_by(user_fct, kind) %>%
  summarise(freq = n()) %>%
  group_by(user_fct) %>%
  mutate(prop = freq/sum(freq)) %>%
  ungroup() %>%
  ggplot() +
  geom_bar(aes(x = kind, y = prop, fill = kind), stat = "identity") + 
  facet_wrap(~user_fct, ncol = 6) + 
  labs(
    x = "Kind of meal",
    y = "Proportion",
    title = "Proportion of Meals"
  ) + 
  guides(fill = guide_legend(nrow = 1)) +
  theme(
    legend.title = element_blank(), 
    legend.position="bottom",
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )
```

User 2254 (classified as "grazer") does indeed eat a lot of snacks, which is consistent with the distribution of her times of meals. The "two meals" users like 2942 and 2800 are eating breakfast and lunch, but not dinner, and user 2948 is a bit of a mistery. The times of the meals are clearly centered around just two key times, but meal kind distribution contains breakfast, lunch and dinner.

It's good to see that breakfast is prominantly featured in almost all users. 

Another observation is that some users eat a lot of snacks, and some users do not.

## Meal nutrients analysis

```{r fig.width=4}
meals.selected %>%
  filter(!is.na(calories_eval)) %>%
  select(user_fct, kind, Carbs = carbs_eval, Protein = protein_eval, Fat = fat_eval, Fiber = fiber_eval) %>%
  gather(key = "Nutrient", value, -user_fct, -kind) %>%
  group_by(user_fct, Nutrient) %>%
  summarise(total=sum(value)) %>%
  group_by(user_fct) %>%
  mutate(prop = total/sum(total)) %>%
  ungroup() %>%
  mutate(Nutrient = fct_relevel(Nutrient, "Carbs", "Protein", "Fat", "Fiber")) %>% 
  ggplot() +
  geom_bar(aes(x = Nutrient, y = prop, fill = Nutrient), stat = "identity") + 
  facet_wrap(~user_fct, ncol = 6) + 
  labs(
    x = "Nutrient",
    y = "Proportion",
    title = "Proportion of nutrients across all meals"
  ) + 
  guides(fill = guide_legend(nrow = 1)) +
  theme(
    legend.title = element_blank(), 
    legend.position="bottom",
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )
  
```

Interesting to note that in almost all users the carbs is the biggest contributor to the diet, then protein, then fat and then fiber. Users that buck that trend are 57, 1884, 2948. 

TODO: Add proportions of nutrients per meal kind by user


## Meal BG impact visualization

This is somewhat un-usual plot, where each line segment represents one meal a user had colored with the meal kind (breakfast, dinner, etc.). The line segment starts at the time (relative to the meal time) and BG of premeal measurement, and ends at the time/BG of the postmeal measurement. The steeper slope of the line indicates higher BG impact of a meal. The red horizontal line shows the diagnostic threshold level of 200mg/dL for postmeal BG to diagnose diabetes.

```{r fig.width=4}
meals.selected %>% 
  ggplot() +
  geom_segment(aes(x = -premeal_bg_delay_minutes, xend = postmeal_bg_delay_minutes, y=premeal_bg, yend=postmeal_bg, color = kind), show.legend = FALSE, alpha = 0.2) + 
  # draw rect purely so that the legend appears as a solid rect, for a line with low alpha which makes it hard to see colors.
  # draw the rects outside of visible X limits set for the X axis.
  geom_rect(aes(xmin = -1000-premeal_bg_delay_minutes, xmax = -1000+postmeal_bg_delay_minutes, ymin=premeal_bg, ymax=postmeal_bg, fill = kind)) + 
  geom_hline(aes(yintercept=200), color="red", show.legend = FALSE, alpha = 0.5) +
  scale_x_continuous(breaks=c(-30, 0, 60, 120, 180, 240), labels = c("", "0", "1h", "2h", "3h", "4h"), limits = c(-30, 240)) + 
  facet_wrap(~user_fct, ncol = 6) + 
  labs(
    x = "Time since meal",
    y = "BG",
    title = "BG impact of meals per user",
    caption = "Red horizontal line indicates warning postmeal BG levele of 180mg/dL"
  ) + 
  guides(color = guide_legend(nrow = 1), fill = guide_legend(nrow = 1)) +
  theme(
    legend.title = element_blank(), 
    legend.position="bottom",
  )
```

Interestingly, most of users manage diabetes well, have a flat response to meals and barely exceeding the warning threshold of 200 mg/dL. Some users (namely 2254, 1809, 2262) have big ups and downs, and in case of user 1809 BG stays above the 200 level all the time.

User 2312 seems to consistently start the day with very low BG in the 50-60 range, and breakfast moves BG in the 100-150 range. This behaviour and impact is very consistent.

User 1821 recorded a lot of dinners (also visible on "Proportion of meals" plot), and the impact of dinners is managed well, with a bump of around 50 BG points per dinner.

User 2942 seems to consistently have breakfasts with an impact of about 25-30 BG points and then lunch that seems to actually lower the BG in postmeal recording. That may indicate that the user takes insulin to manage diabetes. 

## Trends in calories

```{r fig.width=4}
meals.selected %>%
  mutate(eaten_at_date = as.Date(eaten_at, tz = "EST")) %>%
  filter(eaten_at_date <"2019-04-01" & !is.na(calories_eval)) %>%
  group_by(user_fct, eaten_at_date) %>%
  summarise(sum_by_day = sum(eval_calories_computed)) %>%
  ggplot(aes(x=eaten_at_date, y=sum_by_day))+
  geom_point(size=0.1) +
  geom_smooth(method = "lm", na.rm=TRUE, size=0.5) +
  facet_wrap(~user_fct, ncol=6) +
  labs (
    title = "Trend of daily calories consumed by user",
    x = "Time",
    y = "Calories"
  ) + 
  theme(
    axis.text.x = element_text(angle = 90)
  )
# TODO: colorcode facets whis positive vs negative trend
```

At a glance it looks like most of the users either maintained or decreased the number of calories they consume per day. Notable exception is user 2890, whose calories consumption increased. What is concerning about this plot is that for most users the daily calories consumption is well below 2000 calories/day. One explanation is that users didn't record all meals in a day.

Plotting daily amount of carbs consumed (carbs is the most important nutrient to manage for diabetics) by users show the same trends as the calories and is skipped (See appendix)

## Trend in fasting BG

```{r fig.width=4}
meals.selected %>%
  mutate(eaten_at_date = as.Date(eaten_at, tz = "EST")) %>%
  filter(eaten_at_date <"2019-04-01" & !is.na(premeal_bg)) %>%
  filter(kind == 'breakfast') %>%
  group_by(user_fct, eaten_at_date) %>%
  summarise(fasting_bg = first(premeal_bg)) %>%
  ggplot(aes(x=eaten_at_date, y=fasting_bg))+
  geom_point(size=0.1) +
  geom_smooth(method = "lm", na.rm=TRUE, size=0.5) +
  geom_hline(aes(yintercept=125), color="red", show.legend = FALSE, alpha = 0.5) +
  facet_wrap(~user_fct, ncol=6) +
  labs (
    title = "Trend of fasting BG by user",
    x = "Time",
    y = "Fasting BG"
  ) + 
  theme(
    axis.text.x = element_text(angle = 90)
  )
# TODO: colorcode facets whis positive vs negative trend
```

The fasting BG is defined as the first BG measurement after 8h of fasting, normally after sleep in the morning before breakfast. This plot shows the trend of fasting BG by user with a trend line (in blue) and a threshold (in red). The official guidelines to the fasting BG are: below 100 is considered normal (not shown on the plot), 100-125 is pre-diabetes, above 125 leads to a disgosis with diabetes.

For most of the users the trend line looks flat and at or below the threshold level. User 1809 shows a large drop in fasting BG, which would be promising, but unfortunately only few (5) datapoint exist for that user.

## Meal images 

Here we explore the images of meals for user 2254. The first set of images show meals that has the biggest impact over shortest timeframe (`bg_impact_slope`), and the second set show the meals that had smallest (even negative) imapct on BG.

```{r fig.height=5, fig.width=9}
display_meals <- function(df, ncol = 6, nrow = 3, rotate = 0) {
  meals = df[1:(ncol*nrow), ] %>% select(user_id, meal_id)
  filenames = paste0(normalizePath("~/Dropbox/MealyzerData"), "/", meals[["user_id"]], "/images/medium/", meals[["meal_id"]], ".jpg")
  data_uris = sapply(filenames, knitr::image_uri)
  images = tibble(src = data_uris)
  r2d3(data=images, script = "display_meals.js", container = "div", options=list(ncol=ncol, nrow=nrow, rotate=rotate))
}

meals.selected %>%
  filter(user_id == "2254") %>%
  arrange(desc(bg_impact_slope)) %>%
  display_meals(ncol = 6, nrow = 3, rotate = -90)
```


```{r}
meals.selected %>%
  filter(user_id == "2254") %>%
  arrange(bg_impact_slope) %>%
  display_meals(ncol = 6, nrow = 3, rotate = -90)
```

Unsurprisinly the lowest BG impact images are all pictures of water/drinks.


### Per user correlation between variables


```{r fig.width=8, fig.height=8}
meals.selected %>%
  filter(user_id == "2254") %>%
  filter(fiber_eval < 20) %>% # filter outliers
  filter(bg_impact_slope < 5 & bg_impact_slope > -3) %>%
  mutate(
    protein_fat=eval_proportion_protein-eval_proportion_fat, 
    protein_carb=eval_proportion_protein-eval_proportion_carbs, 
    carb_fat=eval_proportion_carbs-eval_proportion_fat) %>%
  select(calories_eval, eval_calories_computed, carbs_eval, fat_eval, protein_eval, fiber_eval, eval_proportion_carbs, eval_proportion_fat, eval_proportion_protein, bg_impact, bg_impact_slope, premeal_bg, postmeal_bg) %>%
  lattice::splom()
```

There is a very strong correlation between `calories_eval` (calories assigned by the evaluator) and `eval_calories_computed` (calories calculated from the nutritional breakdown of a meal into carbs/fat/protein amounts). That shows that evaluator's experience is spot on estimating the meal or the evaluators are using the same formula themselves.

There is a positive correlation between `calories_eval`/`eval_calories_computed` and each of `carbs_eval`, 'fat_eval' and 'protein_eval'. Again, no surprise as the calories can be derived from the nutrients.

A strong negative correlation between `eval_proportion_carbs` and `eval_proportion_fat` shows that when people vary meals they tend to vary between  high carbs low fat and low carbs high fat meals. The proportion of protein stays independent somewhat independent. 

The correlation between `bg_impact` and `bg_impact_slope` also makes sense as the time delay between premeal and postmeal BG is relatively constant at about 2h.


## Looking into meal nutrients estimation (evaluator vs user)

```{r fig.asp=2,fig.width=3}
(function(meals) {
  estimate_diffs = meals %>%
    mutate(
      Calories = calories_user - calories_eval,
      Carbs = carbs_user - carbs_eval,
      Protein = protein_user - protein_eval,
      Fat = fat_user - fat_eval,
      Fiber = fiber_user - fiber_eval,
    ) %>%
    filter(!is.na(Calories) & !is.na(Carbs) & !is.na(Protein) & !is.na(Fat) & !is.na(Fiber))

  g1 = estimate_diffs %>%
    ggplot() +
    geom_boxplot(aes(y = Calories)) +
    geom_hline(aes(yintercept=0), color="black", alpha = 0.5) +
    scale_y_continuous(limits = c(-2000, 2000)) +
    coord_flip() + 
    labs(
      #title = "Aggregate user error in estimating calories",
      y = "Error (grams)"
    ) + 
    cowplot::theme_cowplot(font_size = 10)

  g2 = estimate_diffs %>%
    gather(key = "Nutrient", value = "Error", Carbs, Protein, Fat, Fiber) %>%
    ggplot() +
    geom_boxplot(aes(x = reorder(Nutrient, Error, median), y = Error)) +
    geom_hline(aes(yintercept=0), color="black", alpha = 0.5) +
    scale_y_continuous(limits = c(-100, 100)) +
    coord_flip() + 
    labs(
      #title = "Aggregate user errors in estimating meal nutrients",
      x = "Nutrient",
      y = "Error (grams)"
    ) + 
    cowplot::theme_cowplot(font_size = 10)
  
  g3 = estimate_diffs %>%
    filter(!(user_id %in% c("99", "124", "377", "445", "1663"))) %>%
    ggplot() +
    geom_boxplot(aes(x = fct_rev(user_fct), y = Carbs), varwidth = TRUE) +
    geom_hline(aes(yintercept=0), color="black", alpha = 0.5) +
    scale_y_continuous(limits = c(-100, 100)) +
    coord_flip() + 
    labs(
      #title = "User errors in estimating amount of carbs in meals",
      x = "Users",
      y = "Error (grams)"
    ) +
    cowplot::theme_cowplot(font_size = 10)

    cowplot::plot_grid(g1, g2, g3, align = "hv", nrow = 3, axis = "lr", rel_heights = c(0.75, 2, 5))
})(meals.imputed)
```



Talking points: Aggregate distribution is simmetrical around 0. 
there is no bias on either side. At averages out per user.
THis is BIG! no need to do evaluator estimates if usrs are good at that.
* Slight under-counting of the calories, but not as much as I would expect. High density at 0, suggesting lots of meal the evaluator and user entered exactly the same number of calories, possibly because of 0 calory meal (e.g. water) or known calory meal (e.g. protein bar)
* Systematic under-counting of carbs, slight over-counting of fiber



## Sleep

```{r}
sleep = read_csv(file.path(raw_data_path, "1983", "sleep.csv"), col_types = cols()) %>%
  mutate(time = as.timestamp(time))
```


Questions:
* does the amount of sleep impact the first BG reading in the day (pre-breakfast, important!) (the very first pre-breakfst BG reading is considered fasting and is a true-ish representation of glycemic control (how bad is your diabetis)).
* Does amount (or quality of sleep) have an impoact on pre-breakfast BG (<- new measure). 
* Urban mith - the quality/amount of sleep may change how people respond to meals, e.g. for the same nutritional breakdown of a meal BG_impoact will be different.

* Fat and protein mediate the impact of carbohidrate. How to show this (focus on the visualization, data may be lacking the signal)
